<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>  · lovincode's Blog</title><meta name="description" content=" - lovincode &lt;huonefl@163.com&gt;"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://lovincode.github.io/atom.xml" title="lovincode's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/loveincode" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title"></h1><div class="post-info">2018年4月24日</div><div class="post-content"><p>Java消息服务（Java Message Service， JMS）应用程序接口是一个Java平台中关于面向消息中间件（MOM）的API。</p>
<p>用于两个应用程序之间或分布式系统中发送消息、进行异步通信。</p>
<p>Java消息服务是一个与具体平台无关的API，绝大多数MOM提供商都对JMS提供支持。</p>
<p>Java消息服务的规范包括两种消息模式，点对点和发布者/订阅者。</p>
<p>Java消息服务支持同步和异步的消息处理</p>
<p>Java消息服务支持面向事件的方法接收消息，事件驱动的程序设计现在被广泛认为是一种富有成效的程序设计范例。</p>
<h2 id="13-1-JMS的独立使用"><a href="#13-1-JMS的独立使用" class="headerlink" title="13.1 JMS的独立使用"></a>13.1 JMS的独立使用</h2><ol>
<li>发送端实现<br>发送</li>
<li>接收端实现<br>接收</li>
</ol>
<h2 id="13-2-Spring整合ActiveMQ"><a href="#13-2-Spring整合ActiveMQ" class="headerlink" title="13.2 Spring整合ActiveMQ"></a>13.2 Spring整合ActiveMQ</h2><ol>
<li>Spring配置文件<br>Spring整合消息服务的使用从配置文件配置开始。<br>类似于数据库操作，Spring也将ActiveMQ中的操作统一封装至jmsTemplate中，以便我们统一使用。<br>ActiveMQConnectionFactory用于连接消息服务器，是消息服务的基础，也要注册<br>ActiveMQQueue用于指定消息的目的地</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 第三方MQ工厂: ConnectionFactory --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"targetConnectionFactory"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.ActiveMQConnectionFactory"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ActiveMQ Address --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span> <span class="attr">value</span>=<span class="string">"$&#123;activemq.brokerURL&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userName"</span> <span class="attr">value</span>=<span class="string">"$&#123;activemq.userName&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;activemq.password&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Spring提供的JMS工具类，它可以进行消息发送、接收等 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 队列模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- 这个connectionFactory对应的是我们定义的Spring提供的那个ConnectionFactory对象 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultDestinationName"</span> <span class="attr">value</span>=<span class="string">"$&#123;activemq.queueName&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--这个是目的地:destination --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"destination"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;activemq.queueName&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>发送端<br>Spring可以根据配置信息简化我们的工作量。<br>Spring使用发送消息到消息服务器，省去了冗余的Connection以及Session等的创建与销毁过程，简化了工作量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jmsTemplate.send(destination,<span class="keyword">new</span> MessageCreator()&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> session.createTextMessage(<span class="string">"ceshi"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>接收端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TextMessage msg = (TextMessage)jmsTemplate.receive(destination);</span><br><span class="line">System.out.println(msg.getText());</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>以上的操作<br>jmsTemplate.receive(destination)方法只能接收一次消息，如果未接收到消息，则会一直等待，可设置timeout超时，但是一旦接收到消息本次接收任务就会结束。<br>可通过while(true)来实现循环监听消息服务器的消息。<br>更好的方法创建消息监听器<br><strong>消息监听器使用方式如下：</strong></p>
<ol>
<li>创建消息监听器<br>一旦有新消息Spring会将消息引导至消息监听器以便用户进行相应的逻辑处理<br>MessageListener<br>实现OnMessage()方法<br>OnMessage(Message arg0)</li>
<li>修改配置文件<br>使用消息监听器，需要在配置文件中注册消息容器，并将消息监听器注入到容器中<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置自定义监听：MessageListener --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"textMessageListener"</span> <span class="attr">class</span>=<span class="string">"com.xxx.mq.MessageListener"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 将连接工厂、目标对了、自定义监听注入jms模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sessionAwareListenerContainer"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"destination"</span> <span class="attr">ref</span>=<span class="string">"destination"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageListener"</span> <span class="attr">ref</span>=<span class="string">"textMessageListener"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>通过以上的修改便可以进行消息监听的功能了，一旦有消息传入消息服务器，则会被消息监听器坚挺到，并有Spring将消息内容引导至消息监听器的处理函数中等待用户进一步逻辑处理。</p>
<h2 id="13-3-源码分析"><a href="#13-3-源码分析" class="headerlink" title="13.3 源码分析"></a>13.3 源码分析</h2><h3 id="13-3-1-JmsTemplate"><a href="#13-3-1-JmsTemplate" class="headerlink" title="13.3.1 JmsTemplate"></a>13.3.1 JmsTemplate</h3><ol>
<li>通用代码抽取</li>
<li>发送消息的实现</li>
<li>接收消息<h3 id="13-3-2-监听器容器"><a href="#13-3-2-监听器容器" class="headerlink" title="13.3.2 监听器容器"></a>13.3.2 监听器容器</h3></li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/23/helloworld/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://lovincode.github.io">lovincode <huonefl@163.com></a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>